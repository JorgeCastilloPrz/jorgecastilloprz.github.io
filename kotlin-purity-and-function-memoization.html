<!DOCTYPE html>
<html>
<head>
    
    <link rel="stylesheet" type="text/css" href="/assets/built/style.css" />

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Kotlin purity and function memoization</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code:500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="You'll find all my tech posts here." />
    <link rel="shortcut icon" href="https://jorgecastilloprz.github.io/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="üë®‚Äçüíª Jorge Castillo" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Kotlin purity and function memoization" />
    <meta property="og:description" content="Let‚Äôs learn about the benefits of ‚Äúpurity‚Äù and ‚Äúpure functions‚Äù, and how it affects caching. A pure function is a function that just operates over it‚Äôs input arguments to provide a result. It has no side effects, which means that the function itself is not provoking any external effects that" />
    <meta property="og:url" content="https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization" />
    <meta property="og:image" content="https://jorgecastilloprz.github.io/assets/images/neurons.jpeg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2017-05-17T07:00:00+00:00" />
    <meta property="article:modified_time" content="2017-05-17T07:00:00+00:00" />
    <meta property="article:tag" content="Kotlin" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Kotlin purity and function memoization" />
    <meta name="twitter:description" content="Let‚Äôs learn about the benefits of ‚Äúpurity‚Äù and ‚Äúpure functions‚Äù, and how it affects caching. A pure function is a function that just operates over it‚Äôs input arguments to provide a result. It has no side effects, which means that the function itself is not provoking any external effects that" />
    <meta name="twitter:url" content="https://jorgecastilloprz.github.io/" />
    <meta name="twitter:image" content="https://jorgecastilloprz.github.io/assets/images/neurons.jpeg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="üë®‚Äçüíª Jorge Castillo" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Kotlin" />
    <meta name="twitter:site" content="@jorgecastillopr" />
    <meta name="twitter:creator" content="@jorgecastillopr" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "üë®‚Äçüíª Jorge Castillo",
        "logo": "https://jorgecastilloprz.github.io/"
    },
    "url": "https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization",
    "image": {
        "@type": "ImageObject",
        "url": "https://jorgecastilloprz.github.io/assets/images/neurons.jpeg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization"
    },
    "description": "Let‚Äôs learn about the benefits of ‚Äúpurity‚Äù and ‚Äúpure functions‚Äù, and how it affects caching. A pure function is a function that just operates over it‚Äôs input arguments to provide a result. It has no side effects, which means that the function itself is not provoking any external effects that"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Kotlin purity and function memoization" href="/feed.xml" />

    <style>
        .highlighter-rouge, .highlight, code {
            width: 100%;
        }
    </style>


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://jorgecastilloprz.github.io/">üë®‚Äçüíª Jorge Castillo</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-animations" role="menuitem" style="margin-left: 14px;"><a class="colorWhite" href="/course/">Course üé¨</a></li>
    <li class="nav-androidcourse" style="margin-left: 10px; margin-right: 10px;" role="menuitem"><a class="colorOnHighlight" href="/book/">Book üìñ Jetpack Compose internals üî•</a></li>
    <li class="nav-about" role="menuitem"><a class="menuLink" href="/about/">About</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-tw" href="https://twitter.com/jorgecastillopr" target="_blank" rel="noopener"><img width=26 src="../assets/images/twitter.svg"/></a>
            
            
                <a class="social-link social-link-tw" href="https://androiddev.social/@jorge" target="_blank" rel="noopener"><img width=26 src="../assets/images/mastodon.svg"/></a>
            
        </div>
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post ">

            <header class="post-full-header">
              <section class="post-full-meta">
                  <time class="post-full-meta-date" datetime="17 May 2017">17 May 2017</time>
              </section>

              
                  
                      <span class="post-card-tags"><a style="color:white;" href='/tag/kotlin/'>Kotlin</a></span>
                  
                      <span class="post-card-tags"><a style="color:white;" href='/tag/fp/'>Fp</a></span>
                  
              

                <h1 class="post-full-title">Kotlin purity and function memoization</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/neurons.jpeg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Let‚Äôs learn about the benefits of ‚Äúpurity‚Äù and ‚Äúpure functions‚Äù, and how it affects caching.</p>

<p>A pure function is a function that <strong>just operates over it‚Äôs input arguments to provide a result</strong>. It has no side effects, which means that the function itself is not provoking any external effects that you cannot control or <strong>you don‚Äôt expect</strong>. It‚Äôs not modifying any external state behind the scenes. So if you ran the function one trillion times for the same input arguments you would get the same result one trillion times.</p>

<p>A pretty common example of pure function usage uses to be the one about JDK Math class functions.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">fifteen</span> <span class="p">=</span> <span class="nc">Math</span><span class="p">.</span><span class="nf">abs</span><span class="p">(-</span><span class="mi">15</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">arcTangent</span> <span class="p">=</span> <span class="nc">Math</span><span class="p">.</span><span class="nf">atan</span><span class="p">(</span><span class="mf">90.0</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">arcSine</span> <span class="p">=</span> <span class="nc">Math</span><span class="p">.</span><span class="nf">asin</span><span class="p">(</span><span class="mf">45.0</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">eight</span> <span class="p">=</span> <span class="nc">Math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="mf">64.0</span><span class="p">)</span>
</code></pre></div></div>

<p>All those functions would always return the same results for those given arguments, with no exceptions.</p>

<p>In java it‚Äôs easy to create pure functions. You just mark those functions as <code class="language-plaintext highlighter-rouge">static</code> so those cannot access any state since they aren‚Äôt bound to any enclosing class instance. The compiler itself is going to forbid modification or access to any <strong>non static</strong> external variables from outside the function, but <strong>you shouldn‚Äôt either modify global static ones</strong>.</p>

<p><a href="https://wiki.haskell.org/Referential_transparency">Referential Transparency</a> is a concept definitely present on pure functions. I learned this concept from a <a href="https://www.47deg.com/presentations/2017/02/18/Functional-error-handling/">very interesting talk about Functional Error Handling by Raul Raja</a>.</p>

<p>Referential Transparency means that the function does exactly what it promises when you call it, no more, no less. This concept is pretty beneficial for testability. If your code is most likely based on pure functions, that means it‚Äôs also more predictable. And <strong>predictable code is normally easier to test</strong>. Side effects break referential transparency.</p>

<hr />

<p><img src="assets/images/hermione.gif" alt="Hermione" /></p>

<p><em>Hermione found that purity doesn‚Äôt fit pretty well inside her last released app. She might use some spells to fix it.</em></p>

<p>If you are an Android developer you know about the need to apply side effects at some point, otherwise you couldn‚Äôt render things on screen or query to an API. Well, you can <strong>apply those effects to the edges imposed by your system</strong>. Talking about Android, we would be talking about lifecycle callbacks where Android IoC gives us the control. We will talk a bit about this again in the following paragraphs.</p>

<p>The rest of your architecture could be totally based on <strong>purity-based transformations over the data</strong>, if you wanted.</p>

<p>If you pass all your dependencies as parameters all the way, you will find that you are progressively <strong>getting rid of state</strong> across your architecture except for the edge imposed by it, that would be where the inversion of control is applied (lifecycle callbacks).</p>

<p>In Java, we normally have state all over the place just because OOP, and because we also decide to inject dependencies through constructors / fields and keep their references retained inside class instances. But that‚Äôs our choice on that. It doesn‚Äôt mean we have a requirement to have state, neither an instance. The only meaning of this situation is that the <code class="language-plaintext highlighter-rouge">DI</code> framework we are using is kind of forcing us to have state.</p>

<p>If you start moving towards this mindset, you will find that you could remove a lot of classes and focus more on functions as <strong>first class citizens</strong>.</p>

<p>Also, <strong>having no state means no need to switch those pieces at testing time</strong>. You will be completely safe by using your real production code for all those chained functions inside your tests, since there aren‚Äôt any problematic side effects creating the need for test doubles. And the testing environment should always replicate production code as much as possible, otherwise you wouldn‚Äôt be writing the right tests, isn‚Äôt it?</p>

<p>This enables you to test your app almost end to end in a <strong>black box scenario</strong> just by switching your View implementation (Android) and a couple more side effecting dependencies by test doubles. Purity predictability will make you capable of exercising a bunch of chained functions and easily know what to expect in return for your assertions.</p>

<p>Also, your production dependency trees would be much shorter. Your switchable dependencies would be just the required ones to apply side effects, but other than that your connection between the inner layers would just be a bunch of pure functions calling each other to apply transformations over the data. Something that does not requires to be passed as an injected dependency.</p>

<p>But we also have to look at the possible <strong>disadvantages and caveats of purity</strong>.</p>

<h3 id="-performance-consequences">üò≠ Performance consequences</h3>

<p>By getting rid of the state we are also sacrificing something important. Let‚Äôs say that we have the need for a memory cache of items loaded from the API.</p>

<p>First of all, we see a problem on querying the API, since that‚Äôs a side effect.</p>

<p>Well, a good approach to avoid breaking purity would be to wrap the side effect inside an <code class="language-plaintext highlighter-rouge">IO</code> Monad to defer its execution. This means that we are going to compose a chain of transformations over the data plus the deferred data retrieval by the <code class="language-plaintext highlighter-rouge">IO</code> Monad, and we will run the whole chain from the edge imposed by the system, right when we are ready for it. That will happen on our <code class="language-plaintext highlighter-rouge">onCreate</code> or <code class="language-plaintext highlighter-rouge">onResume</code> Activity / Fragment method, most likely.</p>

<p>So all the side effects are applied on Android lifecycle callbacks, inside the view implementation. So we are safe on this.</p>

<p>But what happens when we have to do some expensive calculations in some of the layers composed just with pure functions? Also, what would happen if we are server side and the mentioned function to do the calculation is called thousands of times?</p>

<p>Let‚Äôs have a look on the following code snippet. It‚Äôs a class instance with some state. It‚Äôs capable of calculating the factors of any possible integer:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">FactorCalculator</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">sumCache</span> <span class="p">=</span> <span class="n">hashMapOf</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">,</span> <span class="nc">Int</span><span class="p">&gt;()</span>
    <span class="kd">val</span> <span class="py">factorCache</span> <span class="p">=</span> <span class="n">hashMapOf</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">,</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;&gt;()</span>

    <span class="k">fun</span> <span class="nf">sumOfFactors</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">=</span> <span class="n">sumCache</span><span class="p">.</span><span class="nf">getOrPut</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="p">{</span>
        <span class="nf">factorsOf</span><span class="p">(</span><span class="n">number</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="k">fun</span> <span class="nf">isFactor</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">potential</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">=</span> <span class="n">number</span> <span class="p">%</span> <span class="n">potential</span> <span class="p">==</span> <span class="mi">0</span>

    <span class="k">fun</span> <span class="nf">factorsOf</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">=</span> <span class="n">factorCache</span><span class="p">.</span><span class="nf">getOrPut</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="p">{</span>
        <span class="p">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">number</span><span class="p">).</span><span class="nf">toList</span><span class="p">().</span><span class="nf">filter</span> <span class="p">{</span> <span class="nf">isFactor</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">sumOfFactors</code> function returns a sum of all the factors from any <code class="language-plaintext highlighter-rouge">Int</code>. That value is calculated by the <code class="language-plaintext highlighter-rouge">factorsOf</code> function, which takes a range from <code class="language-plaintext highlighter-rouge">1</code> to the current <code class="language-plaintext highlighter-rouge">number</code>, converts it to a list and then filters to get just the values that are actually factors of the given <code class="language-plaintext highlighter-rouge">number</code>.</p>

<p>Both functions rely on a <code class="language-plaintext highlighter-rouge">HashMap</code> structure to cache already calculated values results for previous inputs, just to save some CPU cycles and memory. Using the <code class="language-plaintext highlighter-rouge">map.getOrPut()</code> function from Kotlin we simplify the code a bit.</p>

<p>But we have state here, so we don‚Äôt have purity. Our functions are applying side effects over the <code class="language-plaintext highlighter-rouge">HashMap</code> structures. So, let‚Äôs try to convert this class to a bunch of pure functions that just operate over their input parameters:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">sumOfFactors</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">=</span> <span class="nf">factorsOf</span><span class="p">(</span><span class="n">number</span><span class="p">).</span><span class="nf">sum</span><span class="p">()</span>

<span class="k">fun</span> <span class="nf">factorsOf</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">=</span> <span class="p">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">number</span><span class="p">).</span><span class="nf">toList</span><span class="p">().</span><span class="nf">filter</span> <span class="p">{</span> <span class="nf">isFactor</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span> <span class="p">}</span>

<span class="k">fun</span> <span class="nf">isFactor</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="n">potential</span><span class="p">:</span> <span class="nc">Int</span><span class="p">)</span> <span class="p">=</span> <span class="n">number</span> <span class="p">%</span> <span class="n">potential</span> <span class="p">==</span> <span class="mi">0</span>
</code></pre></div></div>

<p>We dropped the concept of class here, as it‚Äôs no longer needed. But during the process, we didn‚Äôt have any other choice than to drop the state since we want those functions to be pure. So we lost our memory caches forever!</p>

<p><img src="assets/images/sad_afflec.gif" alt="Sad Afflec" /></p>

<p><em>Affleck realized at the bar what he lost on that refactor pushed to production hours ago</em></p>

<p>Well, Affleck has <strong>good reasons to be sad</strong>, since his refactor was part of some very often used code from server side, and server response timings are going to be damaged so badly because of it.</p>

<p>Looking back at the previous snippet, it seems like we don‚Äôt have any simple possibility to keep a memory structure storing those already calculated values without provoking side effects.</p>

<p>Well, that‚Äôs not really true and here is were the need for a feature like <strong>function memoization</strong> comes in üéâ.</p>

<h3 id="-function-memoization">ü§î Function memoization</h3>

<p>It‚Äôs a feature commonly built into some programing languages like Groovy, which <strong>enables automatic caching of recurring function-return values</strong>.</p>

<p>The idea around the concept is to provide a memory cache at a function level that stores the already calculated function result values. So if we get this feature we wouldn‚Äôt need a class instance and a field reference to store it for us anymore, it would be held as part of the function language meta-level.</p>

<p>Languages that do not implement this out of the box don‚Äôt have hard times implementing it, although they can lose some syntactic sugar during the process.</p>

<p>Memoizing a function is a <strong>metafunction</strong> application. That means we are doing something to the function itself and how it works at a language meta level and not to the function results or it‚Äôs code implementation.</p>

<p><a href="https://objectpartners.com/2014/01/28/memoization-in-groovy/">Here you have a pretty clear article</a> by Brendon Anderson about how function memoization works in <code class="language-plaintext highlighter-rouge">Groovy</code>. The code examples inside of it are pretty straightforward. I will paste one here to reduce noise so we can talk about it:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">def</span> <span class="n">myClosure</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Integer</span> <span class="n">x</span> <span class="o">-&gt;</span>
    <span class="n">println</span> <span class="s2">"My Closure argument $x"</span>
<span class="o">}.</span><span class="na">memoize</span><span class="o">()</span>

<span class="n">myClosure</span> <span class="mi">3</span>
<span class="n">myClosure</span> <span class="mi">4</span>
<span class="n">myClosure</span> <span class="mi">3</span>
<span class="n">myClosure</span> <span class="mi">4</span>
</code></pre></div></div>

<p>You define a closure and then call the language built-in <code class="language-plaintext highlighter-rouge">memoize()</code> method on top of it to get a memoized version for the same function. This is the resulting output after running the function those 4 times:</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">My</span> <span class="n">Closure</span> <span class="n">argument</span> <span class="mi">3</span>
<span class="n">My</span> <span class="n">Closure</span> <span class="n">argument</span> <span class="mi">4</span>
</code></pre></div></div>

<p>So, quoting the article: <em>‚ÄúYou can see that the code inside the closure was executed only once for each distinct input parameter.‚Äù</em></p>

<p>That‚Äôs because the memoized version of the function is returning already cached results and not recalculating them if it‚Äôs not needed. It just replaces the resulting value with the cached one if the function was called with the same parameters than a previous call so the function code is not really run.</p>

<p><strong>This can be done because the function is pure</strong>, and we can tell that we will always get the same result for the same input parameter. Otherwise we couldn‚Äôt feel safe about replacing it‚Äôs returning value with it‚Äôs cached version.</p>

<p>So, how could I achieve the same behavior in <code class="language-plaintext highlighter-rouge">Kotlin</code>?</p>

<h3 id="-kotlin-implementation">üéÅ Kotlin implementation</h3>

<p>Sad story here: Memoization isn‚Äôt a built-in feature for <code class="language-plaintext highlighter-rouge">Kotlin</code>. I will not paste Ben Affleck here again, but I can pretty much imagine your face.</p>

<p>Anyways, we can still implement it by ourselves so‚Ä¶</p>

<p><img src="assets/images/why_so_serious.gif" alt="why so serious" /></p>

<p>Take a look at this simple Kotlin implementation of the feature:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Memoize1</span><span class="p">&lt;</span><span class="k">in</span> <span class="nc">T</span><span class="p">,</span> <span class="k">out</span> <span class="nc">R</span><span class="p">&gt;(</span><span class="kd">val</span> <span class="py">f</span><span class="p">:</span> <span class="p">(</span><span class="nc">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">R</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="nc">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">R</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">values</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">,</span> <span class="nc">R</span><span class="p">&gt;()</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nc">T</span><span class="p">):</span> <span class="nc">R</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">.</span><span class="nf">getOrPut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">,</span> <span class="nc">R</span><span class="p">&gt;</span> <span class="err">((</span><span class="nf">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">R</span><span class="p">).</span><span class="nf">memoize</span><span class="p">():</span> <span class="p">(</span><span class="nc">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">R</span> <span class="p">=</span> <span class="nc">Memoize1</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">memoizedSumFactors</span> <span class="p">=</span> <span class="p">{</span> <span class="n">x</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">-&gt;</span> <span class="nf">sumOfFactors</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">}.</span><span class="nf">memoize</span><span class="p">()</span>
</code></pre></div></div>

<p>First, let‚Äôs look at the class on top. I have used a class here so it becomes clearer to read, but I could also create an anonymous object extending the correct function type <code class="language-plaintext highlighter-rouge">(T) -&gt; R</code>.</p>

<p>On this basic example I am just covering the case of functions with a standalone parameter that also return a value. But the same strategy could be applied for any number of function arguments.</p>

<p>Taking a cautious look, you will notice that the <code class="language-plaintext highlighter-rouge">Memoize1</code> class receives as function with the type <code class="language-plaintext highlighter-rouge">(T) -&gt; R</code> as a property. Then I overrided the <code class="language-plaintext highlighter-rouge">invoke</code> method to be able to make it‚Äôs implementation rely on a <code class="language-plaintext highlighter-rouge">MutableMap</code>. The map is used to hold the already calculated values as an in memory cache, so the function will return a previously calculated result if the input value is contained in the map. Otherwise, the function will be run and it‚Äôs result will be stored in the map right after that.</p>

<blockquote>
  <p>Overriding invoke is like overriding the main application of the function, which is it‚Äôs main constructor. In Kotlin, a call with the form a() is converted to a.invoke(). You can also invoke any function by using a.invoke() by yourself. This is equivalent to apply() method from Scala.</p>
</blockquote>

<p>I also added an extension method for all the functions with the form <code class="language-plaintext highlighter-rouge">(T) -&gt; R</code>, for any <code class="language-plaintext highlighter-rouge">T</code> and <code class="language-plaintext highlighter-rouge">R</code> types. Thanks to that one, you can call <code class="language-plaintext highlighter-rouge">memoize()</code> over any function that receives a value and returns a result. You will get it‚Äôs memoized version in return.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">val</span> <span class="n">memoizedSumFactors</span> <span class="o">=</span> <span class="o">{</span> <span class="nl">x:</span> <span class="n">Int</span> <span class="o">-&gt;</span> <span class="n">sumOfFactors</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="o">}.</span><span class="na">memoize</span><span class="o">()</span>
<span class="n">memoizedSumFactors</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="c1">// this would be the only one calculated</span>
<span class="n">memoizedSumFactors</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="n">memoizedSumFactors</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="n">memoizedSumFactors</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="n">memoizedSumFactors</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
</code></pre></div></div>

<p>As you can see on the snippet, by using this code you would get your function body run just once, and for the resting calls for the same input value we would get the cached result instead.</p>

<p>So here we got what we where looking for! üéä</p>

<hr />

<p>After writing this article, found out that the really well known library <a href="https://github.com/MarioAriasC/funKTionale">funKTionale</a> from <a href="https://github.com/MarioAriasC">Mario Arias</a> already <a href="https://github.com/MarioAriasC/funKTionale/blob/8c36f2d411691f0fe1da62e720d0a0df2834da2d/funktionale-memoization/src/main/kotlin/org/funktionale/memoization/namespace.kt#L28">implements memoization</a> for Kotlin. It‚Äôs gonna become a really good example of how to enable memoization for functions up to 22 parameters.</p>

<p>As you can see, <a href="https://github.com/MarioAriasC/funKTionale/blob/8c36f2d411691f0fe1da62e720d0a0df2834da2d/funktionale-memoization/src/main/kotlin/org/funktionale/memoization/namespace.kt#L29">he uses objects extending the required function types</a>, instead of named classes, to provide a simpler implementation.</p>

<p>You might think that the code is pretty boilerplate with all those extension functions and classes for the handler. This sort of <em>‚Äúpredef‚Äù</em> files to define language extensions are pretty typical on functional programing. Truth is that thanks to this simple file that you could copy to any of your projects, you enable memoization for any possible function you want to use.</p>

<p>So it should be worth it, isn‚Äôt it?</p>

<p>If you want to avoid the need to implement memoization by yourself, and now that you already know what‚Äôs the concept about, you could add the dependency of <em>funKTionale</em> to your project. If you are moving your app towards a more functional architecture, this library will be handful for you, and it‚Äôs worth it. Thanks to Mario for putting his best efforts on it.</p>

<hr />

<p>This should wrap things up for now. If you are interested on <code class="language-plaintext highlighter-rouge">Kotlin</code> and possible functional approaches around the language, you could want to take a look to the following articles I wrote recently about tail recursion and <em>Dependency Injection</em> using the <code class="language-plaintext highlighter-rouge">Reader</code> monad. You might agree or disagree, but those are interesting concepts pretty handful to understand:</p>

<ul>
  <li><a href="https://medium.com/@JorgeCastilloPr/tail-recursion-and-how-to-use-it-in-kotlin-97353993e17f">Tail recursion and how to use it in Kotlin</a></li>
  <li><a href="https://medium.com/@JorgeCastilloPr/kotlin-dependency-injection-with-the-reader-monad-7d52f94a482e">Kotlin Dependency Injection with the Reader Monad</a></li>
</ul>

<hr />

<p>Please, feel free to add me on Twitter <a href="https://twitter.com/jorgecastillopr">@jorgecastillopr</a> to discuss anything related (or not even related!) to this article. I usually post and retweet about <code class="language-plaintext highlighter-rouge">Kotlin</code> and any other Android development and functional related posts.</p>

<p>If you reached this point you might consider supporting me, üëâ<a href="https://paypal.me/jorgecastilloprz">here</a> you have a link where you could do it. Really appreciated! ü§ó Getting support or not, I will for sure keep writing and providing content for free ‚úÖ</p>

                </div>
            </section>

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="jorge" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/jorge">Jorge Castillo</a></h4>
                                
                                    <p>Android developer, Arrow maintainer, pianist wannabe üéπ</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/jorge">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                  <div id="disqus_thread"></div>
                  <script>

                  /**
                  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

                  var disqus_config = function () {
                      this.page.url = 'https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization';
                      this.page.identifier = 'https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization';
                  };

                  (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = 'https://jorgecastilloblog.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                  })();
                  </script>
                  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover-dark.png)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; üë®‚Äçüíª Jorge Castillo &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/kotlin/">Kotlin</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/sealed-interfaces-kotlin">Sealed interfaces in Kotlin</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/tracking-side-effects-with-suspend">Tracking side effects at compile time with suspend</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/digging-into-kotlin-continuations">Kotlin Continuations</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/kotlin/">
                                
                                    See all 10 posts  ‚Üí
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/kotlin-fp-does-it-make-sense">
                <div class="post-card-image" style="background-image: url(/assets/images/flowerfield.jpeg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/kotlin-fp-does-it-make-sense">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Kotlin</span>
                            
                        
                            
                                <span class="post-card-tags">Fp</span>
                            
                        
                    

                    <h2 class="post-card-title">Kotlin Functional Programming, Does it make sense?</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="Jorge Castillo" />
                        
                        <span class="post-card-author">
                            <a href="/author/jorge/">Jorge Castillo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/tail-recursion-and-how-to-use-it-in-kotlin">
                <div class="post-card-image" style="background-image: url(/assets/images/tail_recursion.jpeg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/tail-recursion-and-how-to-use-it-in-kotlin">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Kotlin</span>
                            
                        
                    

                    <h2 class="post-card-title">Tail recursion and how to use it in Kotlin</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="Jorge Castillo" />
                        
                        <span class="post-card-author">
                            <a href="/author/jorge/">Jorge Castillo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://jorgecastilloprz.github.io/">
            
            <span>üë®‚Äçüíª Jorge Castillo</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Kotlin purity and function memoization</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Kotlin+purity+and+function+memoization&amp;url=https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://jorgecastilloprz.github.io/kotlin-purity-and-function-memoization"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://jorgecastilloprz.github.io/">üë®‚Äçüíª Jorge Castillo</a> &copy; 2025</section>
                <section class="poweredby">
                    <a rel="me" href="https://androiddev.social/@jorge">Mastodon</a>
                </section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/jorgecastillopr" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-142413286-1', 'auto');
  ga('send', 'pageview');

 </script>

<!-- 100% privacy-first analytics -->
<script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>


    <script defer data-domain="jorgecastillo.dev" src="https://plausible.io/js/script.js"></script>

    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
