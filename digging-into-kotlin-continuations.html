<!DOCTYPE html>
<html>
<head>
    
    <link rel="stylesheet" type="text/css" href="/assets/built/style.css" />

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Kotlin Continuations</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code:500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="You'll find all my tech posts here." />
    <link rel="shortcut icon" href="https://jorgecastilloprz.github.io/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://jorgecastilloprz.github.io/digging-into-kotlin-continuations" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="üë®‚Äçüíª Jorge Castillo" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Kotlin Continuations" />
    <meta property="og:description" content="Continuations represent the rest of a program. They are a form of control flow. ü§ñ Compile time Each time Kotlin finds a suspend function, that represents a suspension point that the compiler will desugarize into a callback style. For example: suspend fun doSomething() = "Done!" suspend fun main() { doSomething()" />
    <meta property="og:url" content="https://jorgecastilloprz.github.io/digging-into-kotlin-continuations" />
    <meta property="og:image" content="https://jorgecastilloprz.github.io/assets/images/kyoto.jpeg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2020-09-03T11:00:00+00:00" />
    <meta property="article:modified_time" content="2020-09-03T11:00:00+00:00" />
    <meta property="article:tag" content="Kotlin" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Kotlin Continuations" />
    <meta name="twitter:description" content="Continuations represent the rest of a program. They are a form of control flow. ü§ñ Compile time Each time Kotlin finds a suspend function, that represents a suspension point that the compiler will desugarize into a callback style. For example: suspend fun doSomething() = "Done!" suspend fun main() { doSomething()" />
    <meta name="twitter:url" content="https://jorgecastilloprz.github.io/" />
    <meta name="twitter:image" content="https://jorgecastilloprz.github.io/assets/images/kyoto.jpeg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="üë®‚Äçüíª Jorge Castillo" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Kotlin" />
    <meta name="twitter:site" content="@jorgecastillopr" />
    <meta name="twitter:creator" content="@jorgecastillopr" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "üë®‚Äçüíª Jorge Castillo",
        "logo": "https://jorgecastilloprz.github.io/"
    },
    "url": "https://jorgecastilloprz.github.io/digging-into-kotlin-continuations",
    "image": {
        "@type": "ImageObject",
        "url": "https://jorgecastilloprz.github.io/assets/images/kyoto.jpeg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jorgecastilloprz.github.io/digging-into-kotlin-continuations"
    },
    "description": "Continuations represent the rest of a program. They are a form of control flow. ü§ñ Compile time Each time Kotlin finds a suspend function, that represents a suspension point that the compiler will desugarize into a callback style. For example: suspend fun doSomething() = "Done!" suspend fun main() { doSomething()"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Kotlin Continuations" href="/feed.xml" />

    <style>
        .highlighter-rouge, .highlight, code {
            width: 100%;
        }
    </style>


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://jorgecastilloprz.github.io/">üë®‚Äçüíª Jorge Castillo</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-animations" role="menuitem" style="margin-left: 14px;"><a class="colorWhite" href="/course/">Course üé¨</a></li>
    <li class="nav-androidcourse" style="margin-left: 10px; margin-right: 10px;" role="menuitem"><a class="colorOnHighlight" href="/book/">Book üìñ Jetpack Compose internals üî•</a></li>
    <li class="nav-about" role="menuitem"><a class="menuLink" href="/about/">About</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-tw" href="https://twitter.com/jorgecastillopr" target="_blank" rel="noopener"><img width=26 src="../assets/images/twitter.svg"/></a>
            
            
                <a class="social-link social-link-tw" href="https://androiddev.social/@jorge" target="_blank" rel="noopener"><img width=26 src="../assets/images/mastodon.svg"/></a>
            
        </div>
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post ">

            <header class="post-full-header">
              <section class="post-full-meta">
                  <time class="post-full-meta-date" datetime=" 3 September 2020"> 3 September 2020</time>
              </section>

              
                  
                      <span class="post-card-tags"><a style="color:white;" href='/tag/kotlin/'>Kotlin</a></span>
                  
              

                <h1 class="post-full-title">Kotlin Continuations</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/kyoto.jpeg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Continuations represent the rest of a program. They are a form of control flow.</p>

<h3 id="-compile-time">ü§ñ Compile time</h3>

<p>Each time Kotlin finds a <code class="language-plaintext highlighter-rouge">suspend</code> function, that represents a <strong>suspension point</strong> that the compiler will desugarize into a callback style. For example:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">doSomething</span><span class="p">()</span> <span class="p">=</span> <span class="s">"Done!"</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span> <span class="nf">doSomething</span><span class="p">()</span> <span class="p">}</span>
</code></pre></div></div>

<p>If we remove the boilerplate and metadata to stay simple, that gets decompiled to something like this in Java (using the <code class="language-plaintext highlighter-rouge">tools</code> -&gt; <code class="language-plaintext highlighter-rouge">Kotlin</code> -&gt; <code class="language-plaintext highlighter-rouge">Show Kotlin Bytecode</code> IntellIJ menu option):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// FileKt.java</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">FileKt</span> <span class="o">{</span>
   <span class="nd">@Nullable</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="nf">doSomething</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nc">Continuation</span> <span class="n">$completion</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"Done!"</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Nullable</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="nf">main</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nc">Continuation</span> <span class="n">$completion</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">var10000</span> <span class="o">=</span> <span class="n">doSomething</span><span class="o">(</span><span class="n">$completion</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">var10000</span> <span class="o">==</span> <span class="nc">IntrinsicsKt</span><span class="o">.</span><span class="na">getCOROUTINE_SUSPENDED</span><span class="o">()</span> <span class="o">?</span> <span class="n">var10000</span> <span class="o">:</span> <span class="nc">Unit</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
   <span class="o">}</span>
   
   <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Obviating the need for an enclosing class given the lack of ‚Äúpackage level‚Äù functions in Java, the key point here is how both <code class="language-plaintext highlighter-rouge">suspend</code> functions have been converted into <strong>static functions</strong> that get the <code class="language-plaintext highlighter-rouge">Continuation</code> passed as an explicit argument. This is formally called CPS (<em><a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Continuation Passing Style</a></em>).</p>

<p>You can see how the <code class="language-plaintext highlighter-rouge">main</code> function needs to forward the <code class="language-plaintext highlighter-rouge">$completion</code> continuation to the <code class="language-plaintext highlighter-rouge">doSomething()</code> call.</p>

<p>All that is hidden to us by the Kotlin compiler, that allows to call <code class="language-plaintext highlighter-rouge">suspend</code> functions synchronously, while everything stays asynchronous under the hood. That‚Äôs the magic and the point of all this.</p>

<h3 id="-continuation">‚è© Continuation</h3>

<p>So, as explained above, every <code class="language-plaintext highlighter-rouge">Continuation</code> is <strong>associated with a suspension point</strong>. A continuation is the implicit parameter that the Kotlin compiler passes to any <code class="language-plaintext highlighter-rouge">suspend</code> function when compiling it. It is represented by a basic contract:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="k">in</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">abstract</span> <span class="kd">val</span> <span class="py">context</span><span class="p">:</span> <span class="nc">CoroutineContext</span>
  <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">resumeWith</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="nc">Result</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Under the hood, Kotlin will generate a <code class="language-plaintext highlighter-rouge">ContinuationImpl</code> for this contract for each suspended function, which we will dive into in further sections on this post.</p>

<p>As you can see, it looks like a callback, because that is essentially what it is. You can also find it <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-continuation/">in the official docs</a>. It‚Äôs composed of:</p>

<ul>
  <li>A <code class="language-plaintext highlighter-rouge">CoroutineContext</code> that tells the coroutine <strong>how to suspend</strong> itself.</li>
  <li>A callback to wire results in the end. It uses the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-result/">Kotlin Result datatype</a> for that purpose, so you can resume your program either with a <code class="language-plaintext highlighter-rouge">success</code> or a <code class="language-plaintext highlighter-rouge">failure</code> (exception) as a result. Following docs:</li>
</ul>

<blockquote>
  <p>‚ÄúIt will resume the execution of the corresponding coroutine by passing the given value as the return value of the last suspension point.‚Äù</p>
</blockquote>

<p>So, the continuation decides how the program continues after some work, and that makes it <strong>another form of control flow</strong>. It will be used to coordinate the work between all our <code class="language-plaintext highlighter-rouge">suspend</code> functions.</p>

<p>There are also a couple of extension functions as shortcuts, in case you need to deal with continuations manually at some point:</p>

<ul>
  <li><a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/resume.html"><code class="language-plaintext highlighter-rouge">fun &lt;T&gt; Continuation&lt;T&gt;.resume(value: T)</code></a></li>
  <li><a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/resume-with-exception.html"><code class="language-plaintext highlighter-rouge">fun &lt;T&gt; Continuation&lt;T&gt;.resumeWithException(exception: Throwable)</code></a></li>
</ul>

<p>And a constructor function <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-continuation.html">in the standard library</a> to create a Continuation given a context and a callback function:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">inline</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">Continuation</span><span class="p">(</span>
    <span class="n">context</span><span class="p">:</span> <span class="nc">CoroutineContext</span><span class="p">,</span>
    <span class="k">crossinline</span> <span class="n">resumeWith</span><span class="p">:</span> <span class="p">(</span><span class="nc">Result</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="nc">Unit</span>
<span class="p">):</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>This is handy to have, but overall in Kotlin <strong>you‚Äôll likely not need to write your own Continuations</strong>, unless you are building your own libraries like we do with <a href="https://arrow-kt.io/">Arrow</a>, and only for some very specific use cases. There‚Äôs a little bit more on this topic below.</p>

<p>You will likely rely on the Kotlin <code class="language-plaintext highlighter-rouge">suspend</code> support instead, and let the Kotlin compiler desugar it under the hood for you.</p>

<h3 id="Ô∏è-how-does-it-work-internally">‚öôÔ∏è How does it work internally?</h3>

<p>Recapping about <code class="language-plaintext highlighter-rouge">suspend</code> functions:</p>

<blockquote>
  <p>A <code class="language-plaintext highlighter-rouge">suspend</code> function is a function that can be suspended (paused) and resumed later on. They can execute long running operations in a non blocking way.</p>
</blockquote>

<p>Keeping that in mind, Kotlin can suspend some work at arbitrary points within a Coroutine or a <code class="language-plaintext highlighter-rouge">suspend</code> function, as soon as it finds any <code class="language-plaintext highlighter-rouge">suspend</code> function calls. Those would be the afforementioned <strong>suspension points</strong>.</p>

<p>Like <code class="language-plaintext highlighter-rouge">program</code>, <code class="language-plaintext highlighter-rouge">firstOp</code> and <code class="language-plaintext highlighter-rouge">secondOp</code> in this example:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">firstOp</span><span class="p">()</span> <span class="p">=</span> <span class="k">true</span>
<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">secondOp</span><span class="p">(</span><span class="n">firstRes</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="mi">1</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">program</span><span class="p">():</span> <span class="nc">Int</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">firstRes</span> <span class="p">=</span> <span class="nf">firstOp</span><span class="p">()</span>
  <span class="k">return</span> <span class="nf">secondOp</span><span class="p">(</span><span class="n">firstRes</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>From the Android docs:</p>

<blockquote>
  <p>Kotlin uses a stack frame to manage which function is running along with any local variables. When suspending a coroutine, the current stack frame is copied and saved for later. When resuming, the stack frame is copied back from where it was saved, and the function starts running again.</p>
</blockquote>

<p>That is how the flow and the state of the program can be stored and lately resumed for each suspension point.</p>

<p>For coordinating the different <code class="language-plaintext highlighter-rouge">suspend</code> functions, Kotlin generates a <strong>finite state machine</strong>. It creates a label for each suspension point, so it has a way to jump from one to another. Then it‚Äôs able to call our suspend function recursively with different label values to jump between the different states as required.</p>

<p>The <code class="language-plaintext highlighter-rouge">Continuation</code> will keep track of the current label at any point in time, and will be updated accordingly.</p>

<p>For each suspension point reached, the <code class="language-plaintext highlighter-rouge">Continuation</code> is passed, and lately updated with the corresponding result of the computation (so the next one can have access to it) and the corresponding next label value for the following recursion.</p>

<p>All this is handled into a conveniently generated <code class="language-plaintext highlighter-rouge">ContinuationImpl</code> instance that implements the <code class="language-plaintext highlighter-rouge">Continuation</code> contract and is passed around the different states.</p>

<p>I‚Äôm intentionally staying a bit high level here, because there is <a href="https://proandroiddev.com/how-do-coroutines-work-under-the-hood-803e6e9da8bb">this awesome post</a> by Ashish Kumar for in depth details üëå</p>

<p>About storing and restoring state before and after suspension points, there are also some interesting gotchas on <a href="https://medium.com/@lucianoalmeida1/an-overview-on-kotlin-coroutines-d55e123e137b">this post</a> by Luciano Almeida üôè</p>

<h3 id="Ô∏èÔ∏è-java-interoperability">üïµÔ∏è‚Äç‚ôÄÔ∏è Java interoperability</h3>

<p>As you probably imagine already, the <strong>Kotlin compiler plays a big role</strong> for making the <code class="language-plaintext highlighter-rouge">suspend</code> magic work. That means you will get the most out of this feature if you call suspended functions from Kotlin, not meaning they are not supported at all from Java.</p>

<p>Since our <code class="language-plaintext highlighter-rouge">suspend</code> functions are translated into <strong>static</strong> functions within a class, we should be able to call them from java using a non sugarized standard callback style, by passing an explicit instance of a <code class="language-plaintext highlighter-rouge">Continuation</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">FileKt</span><span class="o">.</span><span class="na">doSomething</span><span class="o">(</span><span class="k">new</span> <span class="nc">Continuation</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resumeWith</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// process result `o`</span>
      <span class="o">}</span>

      <span class="nd">@NotNull</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="nc">CoroutineContext</span> <span class="nf">getContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">EmptyCoroutineContext</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>One issue here is that starting on Kotlin 1.3, <code class="language-plaintext highlighter-rouge">Continuation</code> uses the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin/-result/">Kotlin Result</a> inline class for the <code class="language-plaintext highlighter-rouge">resumeWith</code> method, and <strong>inline classes are not supported by Java</strong>. If you want to use them you must provide explicit wrappers from Kotlin. More details on <a href="https://discuss.kotlinlang.org/t/inline-classes-tedious-to-use-considering-java-interop/9382">this issue</a>.</p>

<p>So, if you try to compile the above Java snippet with the anonymous <code class="language-plaintext highlighter-rouge">Continuation</code> implementation, it will not compile because of the <code class="language-plaintext highlighter-rouge">Result</code> type.</p>

<p>One thing you could do to overcome this issue would be to provide your own <code class="language-plaintext highlighter-rouge">Continuation</code> implementation that maps the Kotlin result to something else, to get rid of it and open the usage from Java. We actually <a href="https://github.com/arrow-kt/arrow-core/blob/master/arrow-core-data/src/main/kotlin/arrow/typeclasses/internal/Continuation.kt">do that in the Arrow library</a>, but with a different ultimate purpose.</p>

<p>But if you really want to call your <code class="language-plaintext highlighter-rouge">suspend</code> functions from Java because you might be facing a gradual migration, there are simpler ways.</p>

<p>One approach would be to translate the <code class="language-plaintext highlighter-rouge">suspend</code> call to a JDK 8 <code class="language-plaintext highlighter-rouge">CompletableFuture</code>, so the bridging allows you to keep the asynchronous use case covered:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">doSomethingFromJava</span><span class="p">()</span> <span class="p">=</span>
  <span class="nc">GlobalScope</span><span class="p">.</span><span class="nf">future</span> <span class="p">{</span> <span class="nf">doSomething</span><span class="p">()</span> <span class="p">}</span>

<span class="c1">// Or with explicit CoroutineContext</span>
<span class="k">fun</span> <span class="nf">doSomethingFromJava</span><span class="p">()</span> <span class="p">=</span>
  <span class="nc">GlobalScope</span><span class="p">.</span><span class="nf">future</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="nc">IO</span><span class="p">)</span> <span class="p">{</span> <span class="nf">doSomething</span><span class="p">()</span> <span class="p">}</span>
</code></pre></div></div>

<p>That will require the jdk8 coroutines integration module though:</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dependencies</span> <span class="o">{</span>
  <span class="n">implementation</span> <span class="s1">'org.jetbrains.kotlinx:kotlinx-coroutines-jdk8'</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And you‚Äôll be able to call it from Java:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="nc">FileKt</span><span class="o">.</span><span class="na">doSomethingFromJava</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</code></pre></div></div>

<p>This is possible because the bridging is done on the Kotlin side, hence the <code class="language-plaintext highlighter-rouge">Result</code> type is not visible from Java anymore.</p>

<blockquote>
  <p>Note that here we‚Äôre using <code class="language-plaintext highlighter-rouge">GlobalScope</code> for the sake of the example, but you should likely use a narrower <code class="language-plaintext highlighter-rouge">CoroutineScope</code> that fits your requirements in case you are using KotlinX Coroutines library. Since that logic is on the Kotlin side, you‚Äôre free to apply any design you want in that sense.</p>
</blockquote>

<p>Another alternative would be to <strong>use the KotlinX Coroutines builders from Java</strong>:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Deferred</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="n">deferred</span> <span class="p">=</span> <span class="nc">BuildersKt</span><span class="p">.</span><span class="nf">async</span><span class="p">(</span>
  <span class="nc">GlobalScope</span><span class="p">.</span><span class="nc">INSTANCE</span><span class="p">,</span>
  <span class="nc">Dispatchers</span><span class="p">.</span><span class="nf">getIO</span><span class="p">(),</span>
  <span class="nc">CoroutineStart</span><span class="p">.</span><span class="nc">DEFAULT</span><span class="p">,</span> <span class="c1">// CoroutineStart.LAZY, or other strategies</span>
  <span class="p">(</span><span class="nc">Function2</span><span class="p">&lt;</span><span class="nc">CoroutineScope</span><span class="p">,</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="err">?</span> <span class="err">super</span> <span class="nc">String</span><span class="p">&gt;,</span> <span class="nc">String</span><span class="p">&gt;)</span> <span class="p">(</span><span class="n">coroutineScope</span><span class="p">,</span> <span class="n">continuation</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">{</span>
    <span class="c1">// do your stuff</span>
    <span class="k">return</span> <span class="s">"Some result"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="nc">Job</span> <span class="n">job</span> <span class="p">=</span> <span class="nc">BuildersKt</span><span class="p">.</span><span class="nf">launch</span><span class="p">(</span>
  <span class="nc">GlobalScope</span><span class="p">.</span><span class="nc">INSTANCE</span><span class="p">,</span>
  <span class="nc">Dispatchers</span><span class="p">.</span><span class="nf">getIO</span><span class="p">(),</span>
  <span class="nc">CoroutineStart</span><span class="p">.</span><span class="nc">DEFAULT</span><span class="p">,</span> <span class="c1">// CoroutineStart.LAZY, or other strategies</span>
  <span class="p">(</span><span class="nc">Function2</span><span class="p">&lt;</span><span class="nc">CoroutineScope</span><span class="p">,</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="err">?</span> <span class="err">super</span> <span class="nc">Unit</span><span class="p">&gt;,</span> <span class="nc">Unit</span><span class="p">&gt;)</span> <span class="p">(</span><span class="n">coroutineScope</span><span class="p">,</span> <span class="n">continuation</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">{</span>
    <span class="c1">// do your stuff</span>
    <span class="k">return</span> <span class="nc">Unit</span><span class="p">.</span><span class="nc">INSTANCE</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="c1">// Usually used to bridge regular blocking code to libraries using suspend, </span>
  <span class="c1">// to be used in main functions like from tests or similar.</span>
  <span class="nc">String</span> <span class="n">result</span> <span class="p">=</span> <span class="nc">BuildersKt</span><span class="p">.</span><span class="nf">runBlocking</span><span class="p">(</span>
    <span class="nc">Dispatchers</span><span class="p">.</span><span class="nf">getIO</span><span class="p">(),</span>
    <span class="p">(</span><span class="nc">Function2</span><span class="p">&lt;</span><span class="nc">CoroutineScope</span><span class="p">,</span> <span class="nc">Continuation</span><span class="p">&lt;</span><span class="err">?</span> <span class="err">super</span> <span class="nc">String</span><span class="p">&gt;,</span> <span class="nc">String</span><span class="p">&gt;)</span> <span class="p">(</span><span class="n">coroutineScope</span><span class="p">,</span> <span class="n">continuation</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">{</span>
      <span class="c1">// do your stuff</span>
      <span class="k">return</span> <span class="s">"Some result"</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If this blocked thread is interrupted, then the coroutine job is cancelled and</span>
  <span class="c1">// * this runBlocking invocation throws InterruptedException.</span>
  <span class="c1">// *</span>
  <span class="c1">// Do something with the interruption error</span>
<span class="p">}</span>
</code></pre></div></div>

<p>These are the standard KotlinX coroutines launchers, but called from Java, so it obviously doesn‚Äôt look that idiomatic. Just another interesting option to share.</p>

<p>Finally, you can make it even easier, and <strong>simply provide Kotlin functions that launch the required coroutines and call those from Java</strong>.</p>

<h3 id="-explicit-usages-of-the-continuation-in-kotlin">üòØ Explicit usages of the Continuation in Kotlin</h3>

<p>As we said you‚Äôll likely not use continuations explicitly in Kotlin, except when you do. There are some use cases where you want control over when the continuation is used to resume the state of your program on a given suspension point. We can see this when we are wrapping callback style apis with <code class="language-plaintext highlighter-rouge">suspendCoroutine</code>:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">syncClick</span><span class="p">():</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="n">suspendCoroutine</span><span class="p">&lt;</span><span class="nc">Unit</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">cont</span> <span class="p">-&gt;</span>
  <span class="n">emptyStateIcon</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span> 
    <span class="n">cont</span><span class="p">.</span><span class="nf">resumeWith</span><span class="p">(</span><span class="nc">Result</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="nc">Unit</span><span class="p">))</span> 
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we get a <code class="language-plaintext highlighter-rouge">cont</code> parameter that‚Äôs our <code class="language-plaintext highlighter-rouge">Continuation</code> that we can use to resume our program with the required result. These wrappers are often used in Android to wrap system listeners to capture user interaction, for example.</p>

<p>But this is dangerous usage actually, because coroutines are <strong>not multishot</strong>. Meaning second time you click on the button, it‚Äôll try to resume an already resumed coroutine using the same continuation, and therefore crash üí•. So you should always <strong>detach your listener</strong> after the first time:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="n">lifecycleScope</span><span class="p">.</span><span class="nf">launchWhenStarted</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nf">syncClick</span><span class="p">()</span>
    <span class="n">result</span> <span class="c1">// "Clicked"</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">suspend</span> <span class="k">fun</span> <span class="nf">syncClick</span><span class="p">():</span> <span class="nc">String</span> <span class="p">=</span> <span class="nf">suspendCoroutine</span> <span class="p">{</span> <span class="n">cont</span> <span class="p">-&gt;</span>
  <span class="n">emptyStateIcon</span><span class="p">.</span><span class="nf">setOnClickListener</span> <span class="p">{</span>
    <span class="n">cont</span><span class="p">.</span><span class="nf">resumeWith</span><span class="p">(</span><span class="nc">Result</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="s">"Clicked"</span><span class="p">))</span>
    <span class="n">emptyStateIcon</span><span class="p">.</span><span class="nf">setOnClickListener</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="c1">// detach!</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This will ensure you get your <code class="language-plaintext highlighter-rouge">result</code> as ‚ÄúClicked‚Äù only once.</p>

<p>As mentioned, this is probably not the best example in the world, since an event like button clicks would be better represented as a <code class="language-plaintext highlighter-rouge">Stream</code> of events you can observe, not a single one, but it‚Äôs a starting point to understand how this works.</p>

<p>You‚Äôll likely use this wrapping style to convert one time triggered async logics, like waiting for a View Layout, for example. Those one time calls that you proactively want to call and ensure they are done before stepping into something else. There‚Äôs a good example of that in <a href="https://medium.com/androiddevelopers/suspending-over-views-19de9ebd7020">this detailed post by Chris Banes</a>.</p>

<p>This is also widely used to wrap things like network, database, file read requests or the like, where third party apis might impose a callback based style, so by wrapping them like this you can interoperate with them <strong>synchronously instead</strong>.</p>

<p>That said, it is <strong>highly recommendable</strong> to use the cancellable alternative instead: <code class="language-plaintext highlighter-rouge">suspendCancellableCoroutine</code>.</p>

<p>It provides a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-cancellable-continuation/index.html">CancellableContinuation</a> instead we can use to wire up cancellation. We could use that in Android to release a listener if the caller coroutine gets cancelled in the scope, for example.</p>

<p>(I‚Äôll copy Chris Banes example here since it‚Äôs pretty self explanatory üôè)</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nc">View</span><span class="p">.</span><span class="nf">awaitNextLayout</span><span class="p">()</span> <span class="p">=</span> <span class="n">suspendCancellableCoroutine</span><span class="p">&lt;</span><span class="nc">Unit</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">cont</span> <span class="p">-&gt;</span>
    <span class="c1">// This lambda is invoked immediately, allowing us to create</span>
    <span class="c1">// a callback/listener</span>

    <span class="kd">val</span> <span class="py">listener</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">View</span><span class="p">.</span><span class="nc">OnLayoutChangeListener</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">onLayoutChange</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span> <span class="p">{</span>
            <span class="c1">// The next layout has happened!</span>
            <span class="c1">// First remove the listener to not leak the coroutine</span>
            <span class="n">view</span><span class="p">.</span><span class="nf">removeOnLayoutChangeListener</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
            <span class="c1">// Finally resume the continuation, and</span>
            <span class="c1">// wake the coroutine up</span>
            <span class="n">cont</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="nc">Unit</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// If the coroutine is cancelled, remove the listener</span>
    <span class="n">cont</span><span class="p">.</span><span class="nf">invokeOnCancellation</span> <span class="p">{</span> <span class="nf">removeOnLayoutChangeListener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span> <span class="p">}</span>
    <span class="c1">// And finally add the listener to view</span>
    <span class="nf">addOnLayoutChangeListener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>

    <span class="c1">// The coroutine will now be suspended. It will only be resumed</span>
    <span class="c1">// when calling cont.resume() in the listener above</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then you can use it like:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">viewLifecycleOwner</span><span class="p">.</span><span class="n">lifecycleScope</span><span class="p">.</span><span class="nf">launch</span> <span class="p">{</span>
  <span class="c1">// do some stuff...</span>
  
  <span class="c1">// Wait for the next layout pass to know height of the view</span>
  <span class="n">titleView</span><span class="p">.</span><span class="nf">awaitNextLayout</span><span class="p">()</span>

  <span class="c1">// Do some other stuff that depends on the view measures...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here, he makes sure that the listener is detached whenever the parent coroutine gets cancelled. In the other hand, if the asynchronous api you are wrapping provides cancellation capabilities, you might want to perform <strong>bidirectional cancellation</strong> and cancel the parent coroutine in return, also. There is also an example of that <a href="https://medium.com/androiddevelopers/suspending-over-views-19de9ebd7020">in the mentioned blogpost</a>.</p>

<blockquote>
  <p>Note that the cancellable variant <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/suspend-cancellable-coroutine.html">is provided by KotlinX Coroutines</a>, not the standard library. <strong>Kotlin stdlib doesn‚Äôt provide cancellation support</strong>, that is provided by runtime libraries built on top of it like <a href="https://github.com/Kotlin/kotlinx.coroutines">KotlinX Coroutines</a> or <a href="https://github.com/arrow-kt/arrow-fx/tree/master/arrow-fx-coroutines">Arrow Fx Coroutines</a>. Both libraries provide support for collaborative cancellation.</p>
</blockquote>

<p>For cases like user interactions you‚Äôd likely prefer a Stream based solution, so for wrapping those you can use either <code class="language-plaintext highlighter-rouge">callbackFlow {}</code> <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/callback-flow.html">from KotlinX Coroutines</a> or <code class="language-plaintext highlighter-rouge">Stream.cancellable {}</code> <a href="https://github.com/arrow-kt/arrow-fx/blob/fb9c1fc18d2d956fb0fa3da3ff443513f73da6c9/arrow-fx-coroutines/src/test/kotlin/arrow/fx/coroutines/stream/CallbackTest.kt#L47">from Arrow Fx Coroutines</a>.</p>

<p>Here is an example of how it would look like using the <strong>Functional Streams</strong> implementation by the upcoming Arrow Fx Coroutines, only as a sneak peek.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nc">SwipeRefreshLayout</span><span class="p">.</span><span class="nf">refreshes</span><span class="p">():</span> <span class="nc">Stream</span><span class="p">&lt;</span><span class="nc">Unit</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">Stream</span><span class="p">.</span><span class="nf">cancellable</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">listener</span> <span class="p">=</span> <span class="nc">SwipeRefreshLayout</span><span class="p">.</span><span class="nc">OnRefreshListener</span> <span class="p">{</span>
    <span class="nf">emit</span><span class="p">(</span><span class="nc">Unit</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="nd">@refreshes</span><span class="p">.</span><span class="nf">setOnRefreshListener</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>
  <span class="nc">CancelToken</span> <span class="p">{</span> <span class="k">this</span><span class="nd">@refreshes</span><span class="p">.</span><span class="nf">setOnRefreshListener</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I‚Äôm not getting deeper into this topic on this post since it‚Äôs out of scope, but you can expect some posts about this idea in the future üëç</p>

<h3 id="-extra-bullets">üí° Extra bullets</h3>

<p>Continuations or Continuation Passing Style is a concept that you can find in Kotlin for encoding control flow, but it‚Äôs essentially a generic programming concept not only tied to Kotlin. You could take it further and implement ‚Äúdelimited continuations‚Äù based on a similar but a bit more advanced idea. When a continuation represents the rest of a program, a delimited continuations captures only some part of it. This is a wide topic with a lot of papers published since quite long ago that could start shining soon in Kotlin üòâ</p>

<p>Here you have some links of interest:</p>

<ul>
  <li><a href="https://gist.github.com/sebfisch/2235780">This gist</a> by <a href="https://gist.github.com/sebfisch">Sebastian Fischer</a> is an interesting source for starting to dig into the concept of Delimited Continuations.</li>
  <li><a href="https://cs.ru.nl/~dfrumin/notes/delim.html">This post</a> by <a href="https://cs.ru.nl/~dfrumin/">Dan Frumin</a>.</li>
  <li><a href="https://medium.com/androiddevelopers/suspending-over-views-19de9ebd7020">Suspending over Views</a> by Chris Banes.</li>
  <li><a href="https://medium.com/androiddevelopers/suspending-over-views-example-260ce3dc9100">Suspending over Views - Example</a> by Chris Banes.</li>
  <li><a href="https://proandroiddev.com/how-do-coroutines-work-under-the-hood-803e6e9da8bb">Suspend functions under the hood</a> by Ashish Kumar.</li>
  <li><a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Continuation Passing Style</a>.</li>
  <li><a href="https://medium.com/@lucianoalmeida1/an-overview-on-kotlin-coroutines-d55e123e137b">An Overview on Kotlin Coroutines</a> by <a href="https://medium.com/@lucianoalmeida1">Luciano Almeida</a>.</li>
</ul>

<hr />

<p>You might be interested in other posts I wrote about Kotlin, like:</p>

<ul>
  <li><a href="https://jorgecastillo.dev/kotlin-sam-conversions">Kotlin SAM conversions</a></li>
</ul>

<p>I share thoughts and ideas <a href="https://twitter.com/JorgeCastilloPR">on Twitter</a> quite regularly. You can also find me <a href="https://www.instagram.com/jorgecastillopr/">on Instagram</a>. See you there!</p>

<p>Stay tunned for Kotlin posts üôå</p>

                </div>
            </section>

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="jorge" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/jorge">Jorge Castillo</a></h4>
                                
                                    <p>Android developer, Arrow maintainer, pianist wannabe üéπ</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/jorge">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                  <div id="disqus_thread"></div>
                  <script>

                  /**
                  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

                  var disqus_config = function () {
                      this.page.url = 'https://jorgecastilloprz.github.io/digging-into-kotlin-continuations';
                      this.page.identifier = 'https://jorgecastilloprz.github.io/digging-into-kotlin-continuations';
                  };

                  (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = 'https://jorgecastilloblog.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                  })();
                  </script>
                  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover-dark.png)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; üë®‚Äçüíª Jorge Castillo &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/kotlin/">Kotlin</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/sealed-interfaces-kotlin">Sealed interfaces in Kotlin</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/tracking-side-effects-with-suspend">Tracking side effects at compile time with suspend</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/kotlin-sam-conversions">Support for Kotlin SAM in release 1.4</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/kotlin/">
                                
                                    See all 10 posts  ‚Üí
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/compose-viewpager">
                <div class="post-card-image" style="background-image: url(/assets/images/painting7.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/compose-viewpager">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Android</span>
                            
                        
                            
                                <span class="post-card-tags">Compose</span>
                            
                        
                    

                    <h2 class="post-card-title">Jetpack Compose ViewPager</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="Jorge Castillo" />
                        
                        <span class="post-card-author">
                            <a href="/author/jorge/">Jorge Castillo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/kotlin-sam-conversions">
                <div class="post-card-image" style="background-image: url(/assets/images/piano.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/kotlin-sam-conversions">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Kotlin</span>
                            
                        
                    

                    <h2 class="post-card-title">Support for Kotlin SAM in release 1.4</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="Jorge Castillo" />
                        
                        <span class="post-card-author">
                            <a href="/author/jorge/">Jorge Castillo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://jorgecastilloprz.github.io/">
            
            <span>üë®‚Äçüíª Jorge Castillo</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Kotlin Continuations</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Kotlin+Continuations&amp;url=https://jorgecastilloprz.github.io/digging-into-kotlin-continuations"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://jorgecastilloprz.github.io/digging-into-kotlin-continuations"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://jorgecastilloprz.github.io/">üë®‚Äçüíª Jorge Castillo</a> &copy; 2025</section>
                <section class="poweredby">
                    <a rel="me" href="https://androiddev.social/@jorge">Mastodon</a>
                </section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/jorgecastillopr" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-142413286-1', 'auto');
  ga('send', 'pageview');

 </script>

<!-- 100% privacy-first analytics -->
<script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>


    <script defer data-domain="jorgecastillo.dev" src="https://plausible.io/js/script.js"></script>

    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
