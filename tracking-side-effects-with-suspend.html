<!DOCTYPE html>
<html>
<head>
    
    <link rel="stylesheet" type="text/css" href="/assets/built/style.css" />

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Tracking side effects at compile time with suspend</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code:500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Work+Sans&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="You'll find all my tech posts here." />
    <link rel="shortcut icon" href="https://jorgecastilloprz.github.io/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="üë®‚Äçüíª Jorge Castillo" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Tracking side effects at compile time with suspend" />
    <meta property="og:description" content="Thinking of suspend as a Kotlin stdlib mechanism for flagging and tracking effects at compile time. Going declarative Functional Programming puts a lot of emphasis on achieving concern separation between the pure logics of a program (algebras) and the runtime used to run it. To guarantee this separation, we need" />
    <meta property="og:url" content="https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend" />
    <meta property="og:image" content="https://jorgecastilloprz.github.io/assets/images/kyoto2.jpeg" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2020-10-10T10:00:00+00:00" />
    <meta property="article:modified_time" content="2020-10-10T10:00:00+00:00" />
    <meta property="article:tag" content="Kotlin" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Tracking side effects at compile time with suspend" />
    <meta name="twitter:description" content="Thinking of suspend as a Kotlin stdlib mechanism for flagging and tracking effects at compile time. Going declarative Functional Programming puts a lot of emphasis on achieving concern separation between the pure logics of a program (algebras) and the runtime used to run it. To guarantee this separation, we need" />
    <meta name="twitter:url" content="https://jorgecastilloprz.github.io/" />
    <meta name="twitter:image" content="https://jorgecastilloprz.github.io/assets/images/kyoto2.jpeg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="üë®‚Äçüíª Jorge Castillo" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Kotlin" />
    <meta name="twitter:site" content="@jorgecastillopr" />
    <meta name="twitter:creator" content="@jorgecastillopr" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "üë®‚Äçüíª Jorge Castillo",
        "logo": "https://jorgecastilloprz.github.io/"
    },
    "url": "https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend",
    "image": {
        "@type": "ImageObject",
        "url": "https://jorgecastilloprz.github.io/assets/images/kyoto2.jpeg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend"
    },
    "description": "Thinking of suspend as a Kotlin stdlib mechanism for flagging and tracking effects at compile time. Going declarative Functional Programming puts a lot of emphasis on achieving concern separation between the pure logics of a program (algebras) and the runtime used to run it. To guarantee this separation, we need"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Tracking side effects at compile time with suspend" href="/feed.xml" />

    <style>
        .highlighter-rouge, .highlight, code {
            width: 100%;
        }
    </style>


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://jorgecastilloprz.github.io/">üë®‚Äçüíª Jorge Castillo</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-animations" role="menuitem" style="margin-left: 14px;"><a class="colorWhite" href="/course/">Course üé¨</a></li>
    <li class="nav-androidcourse" style="margin-left: 10px; margin-right: 10px;" role="menuitem"><a class="colorOnHighlight" href="/book/">Book üìñ Jetpack Compose internals üî•</a></li>
    <li class="nav-about" role="menuitem"><a class="menuLink" href="/about/">About</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-tw" href="https://twitter.com/jorgecastillopr" target="_blank" rel="noopener"><img width=26 src="../assets/images/twitter.svg"/></a>
            
            
                <a class="social-link social-link-tw" href="https://androiddev.social/@jorge" target="_blank" rel="noopener"><img width=26 src="../assets/images/mastodon.svg"/></a>
            
        </div>
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post ">

            <header class="post-full-header">
              <section class="post-full-meta">
                  <time class="post-full-meta-date" datetime="10 October 2020">10 October 2020</time>
              </section>

              
                  
                      <span class="post-card-tags"><a style="color:white;" href='/tag/kotlin/'>Kotlin</a></span>
                  
                      <span class="post-card-tags"><a style="color:white;" href='/tag/android/'>Android</a></span>
                  
              

                <h1 class="post-full-title">Tracking side effects at compile time with suspend</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/kyoto2.jpeg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Thinking of suspend as a Kotlin stdlib mechanism for flagging and tracking effects at compile time.</p>

<h3 id="going-declarative">Going declarative</h3>

<p>Functional Programming puts a lot of emphasis on achieving <strong>concern separation</strong> between the pure logics of a program (<strong>algebras</strong>) and the <strong>runtime</strong> used to run it.</p>

<p>To guarantee this separation, we need mechanisms that allow us to <strong>represent our program in memory</strong>, so we can later <strong>interpret that program with a runtime</strong>. This clear decoupling between the actual program description and the runtime, allows to swap runtime execution strategies, and even apply desired runtime optimizations.</p>

<p>One example of this is the <a href="https://kotlinlang.org/docs/reference/sequences.html">Kotlin stdlib‚Äôs Sequences</a>. Those provide operators to work over the elements lazily while staying declarative. In other words, deferred.</p>

<p>Then we have a few <strong>terminal operators</strong>, which only exist for ultimately consuming / executing the in memory program created and ultimately apply optimizations.</p>

<p>From the docs:</p>

<blockquote>
  <p>‚ÄúActual computing happens only when the result of the whole processing chain is requested.‚Äù</p>
</blockquote>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">words</span> <span class="p">=</span> <span class="s">"The quick brown fox jumps over the lazy dog"</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">wordsSequence</span> <span class="p">=</span> <span class="n">words</span><span class="p">.</span><span class="nf">asSequence</span><span class="p">()</span> <span class="c1">// convert list to a sequence</span>

<span class="kd">val</span> <span class="py">lengthsSequence</span> <span class="p">=</span> <span class="n">wordsSequence</span><span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="nf">println</span><span class="p">(</span><span class="s">"filter: $it"</span><span class="p">);</span> <span class="n">it</span><span class="p">.</span><span class="n">length</span> <span class="p">&gt;</span> <span class="mi">3</span> <span class="p">}</span>
    <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="nf">println</span><span class="p">(</span><span class="s">"length: ${it.length}"</span><span class="p">);</span> <span class="n">it</span><span class="p">.</span><span class="n">length</span> <span class="p">}</span>
    <span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="nf">println</span><span class="p">(</span><span class="s">"Lengths of first 4 words longer than 3 chars"</span><span class="p">)</span>

<span class="c1">// terminal operation: obtaining the result as a List</span>
<span class="nf">println</span><span class="p">(</span><span class="n">lengthsSequence</span><span class="p">.</span><span class="nf">toList</span><span class="p">())</span>
</code></pre></div></div>

<p>Try copying this code, commenting the final line and running it. You‚Äôll see how the sequence is never processed. Before calling terminal operators, what we have is only a <strong>description of a program</strong> waiting to be executed.</p>

<p>Another example of this can be found <a href="https://developer.android.com/jetpack/compose/mental-model">in Jetpack Compose</a>, in case you do Android.</p>

<p>Compose allows us to use <code class="language-plaintext highlighter-rouge">@Composable</code> functions as the atomic pieces to create an in memory description of our UI. Each function describes a <strong>UI effect</strong>. Then, there is a runtime prepared to interpret that <strong>description tree</strong> and apply desired optimizations.</p>

<p>Some examples of runtime optimizations in Compose could be running compositions in parallel, offloading compositions to different threads, running those in different order, or features like <a href="https://developer.android.com/jetpack/compose/mental-model#recomposition">smart recomposition</a>.</p>

<p><code class="language-plaintext highlighter-rouge">@Composable</code> functions have restricted usage. The compose compiler will enforce us to call them from another composable function or an <strong>environment</strong> prepared to run UI effects üëâ <u>An integration point like `setContent {}`</u>.</p>

<blockquote>
  <p>This is particularly important, since this restriction ensures we cannot call composable functions from anywhere, but always from an environment that is able to interpret them and apply the required optimizations.</p>
</blockquote>

<p>But, can we also use these ideas for composing our program pure logics (algebras)? Of course we can, by using <code class="language-plaintext highlighter-rouge">suspend</code>.</p>

<blockquote>
  <p>Suspend is the Kotlin stdlib mechanism to make effects visible for the compiler, so we enforce them to run under an environment that is prepared to run effects. A.K.A: Coroutine, or in other words, a prepared <strong>runtime</strong>.</p>
</blockquote>

<p><a href="https://twitter.com/relizarov/status/1314116971286466560">This Tweet</a> by Roman Elizarov, team lead at JetBrains describes this idea pretty well.</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">The suspend keyword in Kotlin colors parts of the code, marking it as asynchronous, enforcing constraints on how it can be used. This is a good thing. We should not do network I/O calls from anywhere in our code, but only from specially designated places in our architecture.</p>&mdash; Roman Elizarov (@relizarov) <a href="https://twitter.com/relizarov/status/1314116971286466560?ref_src=twsrc%5Etfw">October 8, 2020</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>We shouldn‚Äôt make potentially harmful calls from anywhere, but from an environment that is prepared for it.</p>

<h3 id="making-effects-pure">Making effects pure</h3>

<p>We learned the benefits of concern separation, and that we can achieve it using the power of <code class="language-plaintext highlighter-rouge">suspend</code>.</p>

<blockquote>
  <p>Suspend is the Kotlin stdlib mechanism for flagging effects üëâ ensure they‚Äôre called from the correct places.</p>
</blockquote>

<p>To make an effect pure, just flag it as <code class="language-plaintext highlighter-rouge">suspend</code>.  By doing this we‚Äôll be making Kotlin compiler aware of it, so we‚Äôll not be able to call the effect from anywhere. This will shorten the feedback loop by <strong>moving side effect tracking to compile time</strong>. If we try to call an effect from a not allowed place, we‚Äôll get an instant red underline.</p>

<p>Let‚Äôs go ahead and flag all effects as <code class="language-plaintext highlighter-rouge">suspend</code> in our architecture. Those will likely be closer to the architecture edges, like those places where we load data from network, caches, persistence, access file system, display something on screen, etc.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">UserService</span> <span class="p">{</span> <span class="c1">// Retrofit service</span>
  <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">loadUser</span><span class="p">():</span> <span class="nc">User</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">UserPersistence</span> <span class="p">{</span>
  <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">loadUser</span><span class="p">():</span> <span class="nc">User</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">AnalyticsTracker</span> <span class="p">{</span>
  <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">trackEvent</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nc">Event</span><span class="p">):</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This action will enforce us to also flag the callers as <code class="language-plaintext highlighter-rouge">suspend</code>, and this requirement will crawl up our call stack to effectively enforce us to convert our complete program in a description of a program, meaning going declarative. ‚úÖ</p>

<p>At some point we will reach the integration point, where we‚Äôll require to provide a runtime to run our suspended program üëâ<u>a Coroutine</u>. This will ideally happen as early as possible in our architecture, or in other words, be <strong>as close as possible to our program‚Äôs entry point</strong>.</p>

<p>This is because we are looking for writing our complete program in this declarative style, hence making it completely <strong>pure</strong>. Our program logics as the algebras that describe our program.</p>

<p>Then we‚Äôll leave the runtime as a very thin layer that works as an integration point intentionally constrained to the entry point.</p>

<h3 id="the-runtime">The runtime</h3>

<p>We already know how to achieve concern separation by suspending effects, and our ultimate goal of achieving purity for the complete program. That will also make it more testable, since <strong>purity means determinism, and therefore predictability</strong>.</p>

<p>To provide a decoupled runtime, and for the case of programs with suspended effects (also known as effectful programs), we will need to create a coroutine.</p>

<p>In case we are working with object oriented / imperative style, we are probably using KotlinX Coroutines. We can use the coroutine builders to create one, like <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/launch.html">launch</a> and <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/async.html">async</a>, which will require a <code class="language-plaintext highlighter-rouge">CoroutineScope</code> for the structure concurrency:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">coroutineScope</span> <span class="p">{</span>
    <span class="nf">launch</span> <span class="p">{</span>
       <span class="c1">// Our suspended program üçÉ</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is just an intentionally simple example, but we‚Äôll need to be conscious about the convenient scope to use per use case, or how to create it. The key point here is that we‚Äôve created an environment for running a suspended program.</p>

<p>Let‚Äôs say we‚Äôre not using KotlinX Coroutines, but only the stdlib coroutines support (<code class="language-plaintext highlighter-rouge">suspend</code>, <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-coroutine-context/"><code class="language-plaintext highlighter-rouge">CoroutineContext</code></a>, <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/start-coroutine.html"><code class="language-plaintext highlighter-rouge">startCoroutine</code></a>, <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/suspend-coroutine.html"><code class="language-plaintext highlighter-rouge">suspendCoroutine</code></a>‚Ä¶ etc), we can also have our environment (Coroutine) created like:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">program</span><span class="p">():</span> <span class="nc">Unit</span> <span class="p">=</span> <span class="nc">TODO</span><span class="p">(</span><span class="s">"Our suspended program üçÉ"</span><span class="p">)</span>

<span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">::</span><span class="n">program</span><span class="p">.</span><span class="nf">startCoroutine</span><span class="p">(</span>
    <span class="nc">Continuation</span><span class="p">(</span>
      <span class="n">context</span> <span class="p">=</span> <span class="nc">EmptyCoroutineContext</span><span class="p">,</span>
      <span class="n">resumeWith</span> <span class="p">=</span> <span class="p">{</span> <span class="n">result</span> <span class="p">-&gt;</span> <span class="cm">/* Kotlin Result */</span> <span class="p">}</span>
    <span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So we can create a coroutine over our suspended program with the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/start-coroutine.html"><code class="language-plaintext highlighter-rouge">startCoroutine</code> stdlib call</a>. It‚Äôs a bit more convoluted, since we‚Äôll have to provide implementations for the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-coroutine-context/"><code class="language-plaintext highlighter-rouge">CoroutineContext</code></a>, and the <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines/-continuation.html"><code class="language-plaintext highlighter-rouge">Continuation</code></a>.</p>

<p>Truth is we‚Äôll probably work like this if writing a library built on top of the Kotlin stdlib suspend support. In that case we‚Äôd probably not want to pack KotlinX Coroutines into our library, since it‚Äôs a quite high level library, but work over the stdlib suspend machinery instead to stay efficient. After all, that is also how KotlinX Coroutines was built.</p>

<p>Moving into the Functional Programming world, we‚Äôve got the Arrow Fx Coroutines library instead, which provides the <a href="https://github.com/arrow-kt/arrow-fx/blob/b342185cef8e33fc126715b4b58f7ee3ab7d8bd9/arrow-fx-coroutines/src/main/kotlin/arrow/fx/coroutines/Enviroment.kt#L21"><code class="language-plaintext highlighter-rouge">Environment</code></a>:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">val</span> <span class="py">env</span> <span class="p">=</span> <span class="nc">Environment</span><span class="p">()</span>
  <span class="kd">val</span> <span class="py">cancellable</span> <span class="p">=</span> <span class="n">env</span><span class="p">.</span><span class="nf">unsafeRunAsyncCancellable</span><span class="p">(</span>
    <span class="p">{</span> <span class="c1">// Our suspended program üçÉ },</span>
    <span class="p">{</span> <span class="n">e</span> <span class="p">-&gt;</span> <span class="cm">/* handle errors unhandled by the suspended program */</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">a</span> <span class="p">-&gt;</span> <span class="cm">/* handle result of the program */</span> <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Environment</code> also provides a runtime and takes care of the execution strategy used, providing methods to run our program <a href="https://github.com/arrow-kt/arrow-fx/blob/b342185cef8e33fc126715b4b58f7ee3ab7d8bd9/arrow-fx-coroutines/src/main/kotlin/arrow/fx/coroutines/Enviroment.kt#L40">synchronously</a>, <a href="https://github.com/arrow-kt/arrow-fx/blob/b342185cef8e33fc126715b4b58f7ee3ab7d8bd9/arrow-fx-coroutines/src/main/kotlin/arrow/fx/coroutines/Enviroment.kt#L58">asynchronously</a>, or <a href="https://github.com/arrow-kt/arrow-fx/blob/b342185cef8e33fc126715b4b58f7ee3ab7d8bd9/arrow-fx-coroutines/src/main/kotlin/arrow/fx/coroutines/Enviroment.kt#L67">asynchronously and cancellable</a>, so we can retain a cancellation token to invoke later on and <strong>cancel the whole execution tree</strong>.</p>

<p>We can also pass an explicit <code class="language-plaintext highlighter-rouge">CoroutineContext</code> for executing the program, which by default is the <code class="language-plaintext highlighter-rouge">ComputationPool</code>. The <code class="language-plaintext highlighter-rouge">Environment</code> is actually an interface, so we can provide <strong>our own runtimes</strong> in case we want to, and in case <a href="https://github.com/arrow-kt/arrow-fx/blob/b342185cef8e33fc126715b4b58f7ee3ab7d8bd9/arrow-fx-coroutines/src/main/kotlin/arrow/fx/coroutines/Enviroment.kt#L86">the default one</a> provided by Arrow doesn‚Äôt fit our needs.</p>

<p>In case we want to go for the functional approach, we‚Äôll get access to all the functional effect apis, functional data types, concurrency operators, functional Streams, out of the box cancellation, and all the functional goodies the library provides. All of them are meant to work seamlessly in combination with the <code class="language-plaintext highlighter-rouge">Environment</code>.</p>

<p>One example of this can be the advanced concurrency operators from Arrow Fx Coroutines. Those are meant to run effects, so they‚Äôre also tagged as <code class="language-plaintext highlighter-rouge">suspend</code>, meaning we can‚Äôt really run those outside of a controlled environment. You can have a sneak peek on those <a href="https://www.47deg.com/presentations/2020/10/08/functional-android-apps/">on the slides for my Android Summit talk</a>.</p>

<p>For runtime optimizations, the Arrow team is preparing more advanced work at the <code class="language-plaintext highlighter-rouge">Continuation</code> level that will enable quite interesting behaviors that the Kotlin stdlib doesn‚Äôt support at this point. That will be unveiled in the future, but will leverage the capabilities of concern separation even more. Stay tunned for updates üôå</p>

<h3 id="suspended-entry-points">Suspended entry points</h3>

<p>Some platforms / frameworks provide suspended entry points, like the well known Kotlin <code class="language-plaintext highlighter-rouge">suspend main</code> function, or the Ktor support for writing suspended endpoints.</p>

<p>If a framework provides this, that means the platform is providing us a preconfigured environment to run suspended programs. Therefore, we‚Äôll likely not need to provide one, unless we really want / need to replace it.</p>

<p>Most of the time the platform will have appropiately configured / optimized the environment for the average platform use case. That is picking the proper coroutine context, for example. But in case we want to leverage the upcoming capabilities of Arrow in terms of runtime optimization, we‚Äôll need to replace it with the Arrow <code class="language-plaintext highlighter-rouge">Environment</code>.</p>

<p>We‚Äôll likely write more in depth literature about all that when the time comes.</p>

<h3 id="what-about-writing-our-pure-program">What about writing our pure program?</h3>

<p>Once we‚Äôve got a runtime to interpret our in memory program, and a means to flag side effects to keep those under control by the compiler, we‚Äôll start writing our pure declarative program logics.</p>

<p>In the case of Arrow, we might want to use data types like <code class="language-plaintext highlighter-rouge">Either</code> or <code class="language-plaintext highlighter-rouge">Validated</code> and stay under the suspend umbrella, so we always need a proper environment to run the suspended effectful program. We‚Äôll also be able to leverage the <code class="language-plaintext highlighter-rouge">Either</code> computational blocks and the bindings for composing the program logics through a neat direct syntax.</p>

<p>I‚Äôm planning to write a detailed post on how to write pure logics for our decoupled architectures that will showcase all that plus a lot of concurrency operators, so I‚Äôll not dive deep into that just yet. For now you can have a look to the mentioned <a href="https://www.47deg.com/presentations/2020/10/08/functional-android-apps/">Android Summit talk</a>.</p>

<h3 id="-final-thoughts">üìù Final thoughts</h3>

<p>Any programs can be written in an <strong>eager</strong> or a declarative deferred way. If we go for eager apis our computations will run as we created them, removing any chance of representing the program in memory and interpreting it in different ways later on.</p>

<p>For going declarative we could use data types encoded to be intentionally deferred / lazy, or just <code class="language-plaintext highlighter-rouge">suspend</code>.</p>

<hr />

<p>I want to thank <a href="https://www.47deg.com/">47 Degrees</a> for giving me the chance to learn and communicate all this in diverse forms.</p>

<p>You might be interested in other posts I wrote about Kotlin:</p>

<ul>
  <li><a href="https://www.47deg.com/presentations/2020/10/08/functional-android-apps/">Android Summit talk covering all described in this post in depth</a></li>
  <li><a href="https://jorgecastillo.dev/digging-into-kotlin-continuations">Kotlin Continuations</a></li>
  <li><a href="https://jorgecastillo.dev/kotlin-sam-conversions">Kotlin SAM support</a></li>
  <li><a href="https://jorgecastillo.dev/tag/kotlin/">All Kotlin posts including the FP ones</a></li>
</ul>

<p>I also share thoughts and ideas <a href="https://twitter.com/JorgeCastilloPR">on Twitter</a> quite regularly. You can also find me <a href="https://www.instagram.com/jorgecastillopr/">on Instagram</a>. See you there!</p>

<p>More interesting stuff to come üôå</p>

                </div>
            </section>

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="jorge" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/jorge">Jorge Castillo</a></h4>
                                
                                    <p>Android developer, Arrow maintainer, pianist wannabe üéπ</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/jorge">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                  <div id="disqus_thread"></div>
                  <script>

                  /**
                  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

                  var disqus_config = function () {
                      this.page.url = 'https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend';
                      this.page.identifier = 'https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend';
                  };

                  (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = 'https://jorgecastilloblog.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                  })();
                  </script>
                  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover-dark.png)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; üë®‚Äçüíª Jorge Castillo &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/kotlin/">Kotlin</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/sealed-interfaces-kotlin">Sealed interfaces in Kotlin</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/digging-into-kotlin-continuations">Kotlin Continuations</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/kotlin-sam-conversions">Support for Kotlin SAM in release 1.4</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/kotlin/">
                                
                                    See all 10 posts  ‚Üí
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/sealed-interfaces-kotlin">
                <div class="post-card-image" style="background-image: url(/assets/images/camera.jpeg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/sealed-interfaces-kotlin">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Kotlin</span>
                            
                        
                    

                    <h2 class="post-card-title">Sealed interfaces in Kotlin</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="Jorge Castillo" />
                        
                        <span class="post-card-author">
                            <a href="/author/jorge/">Jorge Castillo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/compose-viewpager">
                <div class="post-card-image" style="background-image: url(/assets/images/painting7.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/compose-viewpager">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Android</span>
                            
                        
                            
                                <span class="post-card-tags">Compose</span>
                            
                        
                    

                    <h2 class="post-card-title">Jetpack Compose ViewPager</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/avatar.jpeg" alt="Jorge Castillo" />
                        
                        <span class="post-card-author">
                            <a href="/author/jorge/">Jorge Castillo</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://jorgecastilloprz.github.io/">
            
            <span>üë®‚Äçüíª Jorge Castillo</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Tracking side effects at compile time with suspend</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Tracking+side+effects+at+compile+time+with+suspend&amp;url=https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://jorgecastilloprz.github.io/tracking-side-effects-with-suspend"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://jorgecastilloprz.github.io/">üë®‚Äçüíª Jorge Castillo</a> &copy; 2025</section>
                <section class="poweredby">
                    <a rel="me" href="https://androiddev.social/@jorge">Mastodon</a>
                </section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/jorgecastillopr" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-142413286-1', 'auto');
  ga('send', 'pageview');

 </script>

<!-- 100% privacy-first analytics -->
<script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>


    <script defer data-domain="jorgecastillo.dev" src="https://plausible.io/js/script.js"></script>

    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
